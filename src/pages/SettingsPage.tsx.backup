import { useRef, useState } from 'react';
import { Download, Upload } from 'lucide-react';
import { Input } from '../components/ui/Input';
import { Select } from '../components/ui/Select';
import { Modal } from '../components/ui/Modal';
import { useFinance } from '../hooks/useFinance';
import { useDataExportImport } from '../hooks/useDataExportImport';
import { t } from '../utils/i18n';
import type { AppSettings } from '../types';

interface SettingsPageProps {
  isOpen: boolean;
  onClose: () => void;
}

export function SettingsPage({ isOpen, onClose }: SettingsPageProps) {
  const { settings, updateSettings, transactions, addBulkTransactions } = useFinance();
  const { downloadJSON, downloadCSV, importFromJSON, importFromCSV } = useDataExportImport();
  const [formData, setFormData] = useState<AppSettings>(settings);
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [importMessage, setImportMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);
  const [fileInputKey, setFileInputKey] = useState(0);
  const importInFlight = useRef(false);
  const [isProcessing, setIsProcessing] = useState(false);

  const resetFileInput = () => {
    setFileInputKey(prev => prev + 1);
  };

  const handleExportJSON = () => {
    downloadJSON(transactions, settings, `fintrack-${new Date().toISOString().split('T')[0]}.json`);
    setImportMessage({ type: 'success', text: settings.language === 'tr' ? 'Veriler baÅŸarÄ±yla dÄ±ÅŸa aktarÄ±ldÄ±!' : 'Data exported successfully!' });
    setTimeout(() => setImportMessage(null), 3000);
  };

  const handleExportCSV = () => {
    downloadCSV(transactions, `fintrack-${new Date().toISOString().split('T')[0]}.csv`);
    setImportMessage({ type: 'success', text: settings.language === 'tr' ? 'Veriler baÅŸarÄ±yla dÄ±ÅŸa aktarÄ±ldÄ±!' : 'Data exported successfully!' });
    setTimeout(() => setImportMessage(null), 3000);
  };

  const handleImportJSON = async (file: File) => {
    // Prevent double execution (Strict Mode-safe)
    if (isProcessing || importInFlight.current) return;
    importInFlight.current = true;
    setIsProcessing(true);
    try {
      const text = await file.text();
      const result = importFromJSON(text);
      if (result.success && result.data) {
        const transactionsToAdd = result.data.transactions.map((t) => ({
          title: t.title || 'Untitled',
          amount: Math.max(0, t.amount || 0),
          category: t.category || 'Other',
          date: t.date || new Date().toISOString().split('T')[0],
          type: t.type || 'expense',
          description: t.description,
          originalCurrency: (t as any).originalCurrency || 'TRY',
        }));
        
        addBulkTransactions(transactionsToAdd);
        const count = result.data.transactions.length;
        
        setImportMessage({ 
          type: 'success', 
          text: settings.language === 'tr' 
            ? `${count} iÅŸlem baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!` 
            : `${count} transactions imported successfully!` 
        });
        // Close modal after successful import
        setTimeout(() => {
          onClose();
          setTimeout(() => setImportMessage(null), 1000);
        }, 500);
      } else {
        setImportMessage({ type: 'error', text: result.message || (settings.language === 'tr' ? 'Dosya yÃ¼kleme baÅŸarÄ±sÄ±z' : 'Import failed') });
        setTimeout(() => setImportMessage(null), 3000);
      }
    } catch (error) {
      console.error('Import error:', error);
      setImportMessage({ type: 'error', text: settings.language === 'tr' ? 'Dosya yÃ¼kleme baÅŸarÄ±sÄ±z' : 'File upload failed' });
      setTimeout(() => setImportMessage(null), 3000);
    } finally {
      setIsProcessing(false);
      importInFlight.current = false;
      resetFileInput();
    }
  };

  const handleImportCSV = async (file: File) => {
    // Prevent double execution (Strict Mode-safe)
    if (isProcessing || importInFlight.current) return;
    importInFlight.current = true;
    setIsProcessing(true);
    try {
      const text = await file.text();
      const result = importFromCSV(text);
      if (result.success && result.data) {
        const transactionsToAdd = result.data.transactions.map((t) => ({
          title: t.title || 'Untitled',
          amount: Math.max(0, t.amount || 0),
          category: t.category || 'Other',
          date: t.date || new Date().toISOString().split('T')[0],
          type: t.type || 'expense',
          description: t.description,
          originalCurrency: (t as any).originalCurrency || 'TRY',
        }));
        
        addBulkTransactions(transactionsToAdd);
        const count = result.data.transactions.length;
        
        setImportMessage({ 
          type: 'success', 
          text: settings.language === 'tr' 
            ? `${count} iÅŸlem baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!` 
            : `${count} transactions imported successfully!` 
        });
        // Close modal after successful import
        setTimeout(() => {
          onClose();
          setTimeout(() => setImportMessage(null), 1000);
        }, 500);
      } else {
        setImportMessage({ type: 'error', text: result.message || (settings.language === 'tr' ? 'Dosya yÃ¼kleme baÅŸarÄ±sÄ±z' : 'Import failed') });
        setTimeout(() => setImportMessage(null), 3000);
      }
    } catch (error) {
      console.error('Import error:', error);
      setImportMessage({ type: 'error', text: settings.language === 'tr' ? 'Dosya yÃ¼kleme baÅŸarÄ±sÄ±z' : 'File upload failed' });
      setTimeout(() => setImportMessage(null), 3000);
    } finally {
      setIsProcessing(false);
      importInFlight.current = false;
      resetFileInput();
    }
  };

  const validateForm = () => {
    const newErrors: Record<string, string> = {};

    if (formData.inflationRate < 0) {
      newErrors.inflationRate = settings.language === 'tr'
        ? 'Enflasyon oranÄ± 0 veya daha bÃ¼yÃ¼k olmalÄ±dÄ±r'
        : 'Inflation rate must be 0 or greater';
    }

    if (formData.inflationRate > 1000) {
      newErrors.inflationRate = settings.language === 'tr'
        ? 'Enflasyon oranÄ± 1000\'den kÃ¼Ã§Ã¼k olmalÄ±dÄ±r'
        : 'Inflation rate must be less than 1000';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = () => {
    if (!validateForm()) return;

    updateSettings(formData);
    setErrors({});
    onClose();
  };

  const handleReset = () => {
    setFormData(settings);
    setErrors({});
  };

  return (
    <Modal
      isOpen={isOpen}
      title={t('settings', settings.language)}
      onClose={() => {
        handleReset();
        onClose();
      }}
      onConfirm={handleSubmit}
      confirmLabel={t('save', settings.language)}
    >
      <div className="space-y-6">
        {/* Appearance Settings Section */}
        <section className="border-b border-slate-200 dark:border-slate-700 pb-6">
          <h3 className="text-base font-semibold text-slate-900 dark:text-white mb-4">
            {settings.language === 'tr' ? 'ğŸ¨ GÃ¶rÃ¼nÃ¼m' : 'ğŸ¨ Appearance'}
          </h3>
          <div className="space-y-4">
            <Select
              label={t('theme', settings.language)}
              value={formData.theme}
              onChange={(e) => setFormData({ ...formData, theme: e.target.value as 'light' | 'dark' })}
              options={[
                { value: 'light', label: t('light', settings.language) },
                { value: 'dark', label: t('dark', settings.language) },
              ]}
            />

            <Select
              label={t('language', settings.language)}
              value={formData.language}
              onChange={(e) => setFormData({ ...formData, language: e.target.value as 'tr' | 'en' })}
              options={[
                { value: 'tr', label: 'TÃ¼rkÃ§e' },
                { value: 'en', label: 'English' },
              ]}
            />
          </div>
        </section>

        {/* Localization Settings Section */}
        <section className="border-b border-slate-200 dark:border-slate-700 pb-6">
          <h3 className="text-base font-semibold text-slate-900 dark:text-white mb-4">
            {settings.language === 'tr' ? 'ğŸŒ YerelleÅŸtirme' : 'ğŸŒ Localization'}
          </h3>
          <Select
            label={t('currency', settings.language)}
            value={formData.currency}
            onChange={(e) => setFormData({ ...formData, currency: e.target.value as 'TRY' | 'USD' | 'EUR' | 'GBP' })}
            options={[
              { value: 'TRY', label: 'â‚º TRY (TÃ¼rk LirasÄ±)' },
              { value: 'USD', label: '$ USD (US Dollar)' },
              { value: 'EUR', label: 'â‚¬ EUR (Euro)' },
              { value: 'GBP', label: 'Â£ GBP (British Pound)' },
            ]}
          />
        </section>

        {/* Financial Settings Section */}
        <section className="border-b border-slate-200 dark:border-slate-700 pb-6">
          <h3 className="text-base font-semibold text-slate-900 dark:text-white mb-4">
            {settings.language === 'tr' ? 'ğŸ’° Finansal Parametreler' : 'ğŸ’° Financial Parameters'}
          </h3>
          <div className="space-y-3">
            <Input
              label={t('inflationRate', settings.language)}
              type="number"
              min="0"
              max="1000"
              step="0.1"
              value={formData.inflationRate.toString()}
              onChange={(e) => setFormData({ ...formData, inflationRate: parseFloat(e.target.value) || 0 })}
              error={errors.inflationRate}
            />
            <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
              <p className="text-xs text-blue-800 dark:text-blue-200 mb-2">
                {settings.language === 'tr'
                  ? 'ğŸ’¡ Enflasyon oranÄ±, gerÃ§ek servet hesaplamasÄ±nda kullanÄ±lÄ±r.'
                  : 'ğŸ’¡ Inflation rate is used for real wealth calculations.'}
              </p>
              <p className="text-xs text-blue-700 dark:text-blue-300">
                {settings.language === 'tr'
                  ? 'ğŸ“Œ Ã–rnek: TÃ¼rkiye ~30%, ABD ~2%'
                  : 'ğŸ“Œ Example: Turkey ~30%, US ~2%'}
              </p>
            </div>
          </div>
        </section>

        {/* Data Management Section */}
        <section className="pb-6">
          <h3 className="text-base font-semibold text-slate-900 dark:text-white mb-4">
            {settings.language === 'tr' ? 'ğŸ’¾ Veri YÃ¶netimi' : 'ğŸ’¾ Data Management'}
          </h3>
          
          <div className="space-y-4">
            {/* Export Subsection */}
            <div>
              <p className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                {settings.language === 'tr' ? 'ğŸ“¥ DÄ±ÅŸa Aktar' : 'ğŸ“¥ Export'}
              </p>
              <div className="grid grid-cols-2 gap-2">
                <div
                  className="flex items-center justify-center gap-2 cursor-pointer px-3 py-2.5 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 transition-colors text-xs font-medium"
                  onClick={handleExportJSON}
                >
                  <Download size={14} />
                  JSON
                </div>
                <div
                  className="flex items-center justify-center gap-2 cursor-pointer px-3 py-2.5 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 transition-colors text-xs font-medium"
                  onClick={handleExportCSV}
                >
                  <Download size={14} />
                  CSV
                </div>
              </div>
              <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                {settings.language === 'tr'
                  ? 'TÃ¼m iÅŸlemlerinizi yedekleyin'
                  : 'Backup all your transactions'}
              </p>
            </div>

            {/* Import Subsection */}
            <div>
              <p className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                {settings.language === 'tr' ? 'ğŸ“¤ Ä°Ã§e Aktar' : 'ğŸ“¤ Import'}
              </p>
              <div className="grid grid-cols-2 gap-2">
                <label className="block">
                  <input
                    key={`json-${fileInputKey}`}
                    type="file"
                    accept=".json"
                    onChange={(e) => {
                      // Guard against double events
                      const file = e.target.files?.[0];
                      if (!file) return;
                      if (importInFlight.current || isProcessing) return;
                      handleImportJSON(file);
                      // Clear input value to avoid re-triggering with same file
                      e.currentTarget.value = '';
                    }}
                    className="hidden"
                    id="json-import"
                  />
                  <div
                    className="flex items-center justify-center gap-2 cursor-pointer px-3 py-2.5 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-700 dark:text-blue-300 transition-colors text-xs font-medium"
                    onClick={() => document.getElementById('json-import')?.click()}
                  >
                    <Upload size={14} />
                    JSON
                  </div>
                </label>

                <label className="block">
                  <input
                    key={`csv-${fileInputKey}`}
                    type="file"
                    accept=".csv"
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      if (importInFlight.current || isProcessing) return;
                      handleImportCSV(file);
                      e.currentTarget.value = '';
                    }}
                    className="hidden"
                    id="csv-import"
                  />
                  <div
                    className="flex items-center justify-center gap-2 cursor-pointer px-3 py-2.5 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-700 dark:text-blue-300 transition-colors text-xs font-medium"
                    onClick={() => document.getElementById('csv-import')?.click()}
                  >
                    <Upload size={14} />
                    CSV
                  </div>
                </label>
              </div>
              <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                {settings.language === 'tr'
                  ? 'Daha Ã¶nce yedeklenen verileri geri yÃ¼kleyin'
                  : 'Restore previously backed up data'}
              </p>
            </div>
          </div>

          {/* Status Message */}
          {importMessage && (
            <div className={`mt-4 p-3 rounded-lg text-xs font-medium ${
              importMessage.type === 'success'
                ? 'bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-200'
                : 'bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 text-rose-700 dark:text-rose-200'
            }`}>
              {importMessage.type === 'success' ? 'âœ“ ' : 'âœ• '}{importMessage.text}
            </div>
          )}
        </section>
      </div>
    </Modal>
  );
}
